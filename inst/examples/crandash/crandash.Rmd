---
title: "cran.rstudio.com"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: https://git.io/vaZdx
runtime: shiny
---

```{r setup, include=FALSE}
# Access to CRAN packages data stream
source("package_stream.R")

# pkgStream is a reactive expression that represents a stream of
# new package download data; up to once a second it may return a
# data frame of new downloads since the last update.
pkgStream <- packageStream(getDefaultReactiveDomain())

# pkgData is a reactive expression that accumulates previous values
# of pkgStream, discarding any that are older than maxAgeSecs.
maxAgeSecs <- 60 * 5 
pkgData <- packageData(pkgStream, maxAgeSecs)
```

Dashboard
=======================================================================

Row
-----------------------------------------------------------------------

### Downloads per sec (last 5 min) {.value-box .bg-info data-icon="fa-area-chart"}

```{r}
# downloadRate is a reactive expression that computes the download
# rate during this dashboard's lifetime.
startTime <- as.numeric(Sys.time())
downloadRate <- reactive({
  elapsed <- as.numeric(Sys.time()) - startTime
  nrow(pkgData()) / min(maxAgeSecs, elapsed)
})

# Emit the download rate
renderText({
  formatC(downloadRate(), digits = 1, format = "f")
})

```

### Total downloads {.value-box data-icon="fa-download"}

```{r}
# dlCount is a reactive expression that keeps track of the total
# number of rows that have ever appeared through pkgStream.
dlCount <- downloadCount(pkgStream)

# Emit the download count
renderText({
  dlCount()
})
```

### Unique users {.value-box data-icon="fa-users"}

```{r}
# usrCount is a reactive expression that keeps an approximate
# count of all of the unique users that have been seen since the
# app started.
usrCount <- userCount(pkgStream)

# Emit the user count
renderText({
  usrCount()
})
```

Row
-----------------------------------------------------------------------

### Popularity by package (last 5 min) {data-width=700}

```{r}
renderBubbles({
  if (nrow(pkgData()) == 0)
    return()

  order <- unique(pkgData()$package)
  df <- pkgData() %>%
    group_by(package) %>%
    tally() %>%
    arrange(desc(n), tolower(package)) %>%
    # Just show the top 60, otherwise it gets hard to see
    head(60)

  bubbles(df$n, df$package, key = df$package)
})
```

### Percent of downloads {data-width=300}

```{r}
renderTable({
  pkgData() %>%
    group_by(package) %>%
    tally() %>%
    arrange(desc(n), tolower(package)) %>%
    mutate(percentage = n / nrow(pkgData()) * 100) %>%
    select("Package" = package, "Percent" = percentage) %>%
    as.data.frame() %>%
    head(30)
}, digits = 1)

```

Raw Data
=======================================================================

### Last 250 Downloads

```{r}
renderTable({
  downloads <- pkgData()
  tail(downloads, n = 250)
})
```

